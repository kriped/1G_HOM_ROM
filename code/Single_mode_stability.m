clc; clear; close all;
load("Results\initialise.mat")
load("Results\solutions_short.mat")

%% data prep
solution = struct('time', cell(1, n+1), 'state_values', cell(1, n+1));
for i = ni:ne
solution(i).state_values = [solution1(i).state_values; solution2(i).state_values];
solution(i).time = [solution1(i).time; solution2(i).time];
end
%%

Analysis=struct("CoefValues",zeros(1,n),...
    "Fit",cell(1,n),...
    "Fit1", cell(1,n),...
    "Fit2", cell(1,n),...
    "Fittype",strings(1,n),...
    "Alpha_guess", zeros(1,n),...
    "Period_guess",zeros(1,n)...
);
% analysis(1:20).values = [1:20];
% analysis(1:20).fit = [1:20];
% analysis(1:20).fittype=strings(1,20);
% analysis(1:20).plot = gobjects(1,20);

%% Real part of the three roots for each mode
mathematica_values_1=[-46.1642, -79.3968, -96.4609, -96.4609, -131.42, -131.42, -148.855, ...
-168.523, -168.523, -201.126, -201.126, -203.625, -204.554, -204.554, ...
-238.061, -259.685, -259.685, -274.413, -274.413, -296.463];

mathematica_values_im1 = [1.0842*10^-18, 2.71051*10^-19, 0, 0, 0, 0, 0, 0, 0, 0., ...
 2.71051*10^-20, 8.13152*10^-20, 2.71051*10^-20, -2.71051*10^-20, ...
 2.1684*10^-19, 2.71051*10^-20, 8.13152*10^-20, -2.71051*10^-20, ...
 5.42101*10^-20, 1.89735*10^-19];

mathematica_values_2 = [0.00327973, 0.000794015, 0.000214581, 0.000214581, -0.0000541088, ...
-0.0000541088, -0.000140836, -0.000195769, -0.000195769, ...
-0.0000847861, -0.0000847845, -0.0000808615, -0.0000827907, ...
-0.0000827944, -0.0000635948, -0.0000578127, -0.0000578112, ...
-0.0000547598, -0.0000547598, -0.0000513168];

mathematica_values_im2 = [1.24345*10^-14, ...
 2.4869*10^-14, -0.0000224643, -0.0000224798, -0.000185485, ...
-0.000185486, -0.000155303, -0.0000370863, -0.0000371147, 0., ...
 2.84217*10^-14, 4.26326*10^-14, 2.13163*10^-14, -2.13163*10^-14, ... 
 8.52651*10^-14, -1.42109*10^-14, 4.26326*10^-14, -2.84217*10^-14, ...
 1.42109*10^-14, 8.52651*10^-14];

mathematica_values_3 =[0.0000176591, 0.0000580158, 0.000214581, 0.000214581, -0.0000541088, ...
-0.0000541088, -0.000140836, -0.000195769, -0.000195769, ...
-0.000422496, -0.000422498, -0.000608629, -0.000385563, -0.00038556, ...
-0.000621865, -0.000605837, -0.000605839, -0.000561025, -0.000561025, ...
-0.000549271];

mathematica_values_im3 = [-1.24345*10^-14, -2.4869*10^-14, 0.0000224643, 0.0000224798, ...
0.000185485, 0.000185486, 0.000155303, 0.0000370863, 0.0000371147, ...
0., -2.84217*10^-14, -4.26326*10^-14, -2.13163*10^-14, ...
2.13163*10^-14, -8.52651*10^-14, 1.42109*10^-14, -4.26326*10^-14, ...
2.84217*10^-14, -1.42109*10^-14, -8.52651*10^-14];

mat_vals_1 = mathematica_values_1(ni:ne);
mat_vals_im1 = mathematica_values_im1(ni:ne);
mat_vals_2 = mathematica_values_2(ni:ne);
mat_vals_im2 = mathematica_values_im2(ni:ne);
mat_vals_3 = mathematica_values_3(ni:ne);
mat_vals_im3 = mathematica_values_im3(ni:ne);


phase_guess1 = atan(mat_vals_im2(i)/mat_vals_2(i));
phase_guess2 = atan(mat_vals_im3(i)/mat_vals_3(i));

%% Calculate stability
 for i = ni:ne

ft = fittype('a*exp(b*x)*cos(c*x+l)+d*exp(e*x)*cos(f*x+m)+g*exp(h*x)*cos(k*x+n)',...
        'dependent',{'y'},...
        'coefficients', {'a','b','c','d','e','f','g','h','k','l','m','n'},...
        'independent',{'x'}...
        );    

 x0 = [P0,mat_vals_1(i),0,0,mat_vals_2(i),mat_vals_im2(i),0,mat_vals_3(i),mat_vals_im3(i),0,0,0];

Analysis(i).Fit=fit(solution(i).time,solution(i).state_values(:,1),...
        ft,...
        'StartPoint',x0,...
        'Lower',[0,-350,-1e-03,0,-0.001,-0.001,0,-0.001,-0.001,-0.01,-2*pi,-2*pi],...
        'Upper',[0.2,-10,1e-03,0.001,0.005,0.001,0.001,0.005,0.001,0.01,2*pi,2*pi]);
    
    Analysis(i).Fittype = ft;
    fig=figure('Visible',true);
    plot(Analysis(i).Fit,solution(i).time(:,1),solution(i).state_values(:,1))
    title(sprintf("Mode %i full fit",i))
    savefig(sprintf("Results/Figure_%i.fig",i));
    Analysis(i).CoefValues = coeffvalues(Analysis(i).Fit);
    %% Analysis part 1
    ft1 = fittype('a*exp(b*x)',...
        'dependent',{'y'},...
        'coefficients', {'a','b'},...
        'independent',{'x'}...
        );    
    x01 = [P0,mat_vals_1(i)];

    Fit1=fit(solution1(i).time,solution1(i).state_values(:,1),...
        ft1,...
        'StartPoint',x01,...
        'Lower',[0,-350],...
        'Upper',[0.2,-10]);
    
    fig1=figure('Visible',true);
    plot(Fit1,solution1(i).time(:,1),solution1(i).state_values(:,1))
    title(sprintf("Mode %i part 1",i))
    Analysis(i).Fit1 = Fit1;
    %% Analysis part 2
    ft2 = fittype('d*exp(e*x)*cos(f*x+m)+g*exp(h*x)*cos(k*x+n)',...
        'dependent',{'y'},...
        'coefficients', {'d','e','f','g','h','k','m','n'},...
        'independent',{'x'}...
        );
    phase_guess1 = atan(mat_vals_im2(i)/mat_vals_2(i));
    phase_guess2 = atan(mat_vals_im3(i)/mat_vals_3(i));
    x02 = [solution1(i).state_values(end,1),mat_vals_2(i),mat_vals_im2(i),0,mat_vals_3(i),mat_vals_im3(i),phase_guess1,phase_guess2];

    Fit2=fit(solution2(i).time,solution2(i).state_values(:,1),...
        ft2,...
        'StartPoint',x02,...
        'Lower',[-0.001,-0.001,-0.001,-0.001,-0.001,-pi,-pi],...
        'Upper',[0.005,0.001,0.001,0.005,0.001,pi,pi]);
    
    fig2=figure('Visible',true);
    plot(Fit2,solution2(i).time(:,1),solution2(i).state_values(:,1))
    title(sprintf("Mode %i part 2",i))
    Analysis(i).Fit2 = Fit2;
% ft = fittype('a*exp(b*x)*cos(c*x)+d*exp(e*x)*cos(f*x)+g*exp(h*x)*cos(k*x)',...
%         'dependent',{'y'},...
%         'coefficients', {'a','b','c','d','e','f','g','h','k'},...
%         'independent',{'x'}...
%         );    
% 
%  x0 = [P0,mat_vals_1(i),0,0,mat_vals_2(i),mat_vals_im2(i),0,mat_vals_3(i),mat_vals_im3(i)];
% 
% Analysis(i).Fit=fit(solution(i).time,solution(i).state_values(:,1),...
%         ft,...
%         'StartPoint',x0,...
%         'Lower',[0,-350,-1e-03,0,-0.001,-0.001,0,-0.001,-0.001],...
%         'Upper',[0.2,-10,1e-03,0.001,0.005,0.001,0.001,0.005,0.001]);
%     
%     Analysis(i).Fittype = ft;
%     fig=figure('Visible',true);
%     plot(Analysis(i).Fit,solution(i).time(:,1),solution(i).state_values(:,1))
%     savefig(sprintf("Results/Figure_%i.fig",i));
%     Analysis(i).CoefValues = coeffvalues(Analysis(i).Fit);


% ft = fittype('a*exp(b*x)+c*exp(d*x)+f*exp(g*x)',...
%         'dependent',{'y'},...
%         'coefficients', {'a','b','c','d','f','g'},...
%         'independent',{'x'}...
%         );    
% 
%  x0 = [P0,mat_vals_1(i),0,mat_vals_2(i),0,mat_vals_3(i)];
% 
% Analysis(i).Fit=fit(solution(i).time,solution(i).state_values(:,1),...
%         ft,...
%         'StartPoint',x0,...
%         'Lower',[0,-350,0,-0.001,0,-0.001],...
%         'Upper',[0.2,-10,0.001,0.005,0.001,0.005]);
%     
%     Analysis(i).Fittype = ft;
%     fig=figure('Visible',true);
%     plot(Analysis(i).Fit,solution(i).time(:,1),solution(i).state_values(:,1))
%     savefig(sprintf("Results/Figure_%i.fig",i));
%     Analysis(i).CoefValues = coeffvalues(Analysis(i).Fit);
    %val1 =  solution(i).state_values(1,1); val2 = solution(i).state_values(end,1);
    %t1 = solution(i).time(1,1); t2 = solution(i).time(end,1);
    %Analysis(i).Period_guess = t2-t1;
    %Analysis(i).Alpha_guess = log(val2/val1)/Analysis(i).Period_guess;
%end
 end
 %% clean and save results
clear t1 t2 val1 val2 pks locs fig fig1 fig2
save("Results\Analysis.mat")